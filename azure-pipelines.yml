trigger:
  branches:
    include:
      - main # Trigger on every push to main

pool:
  vmImage: "ubuntu-latest"

steps:
  # âœ… Checkout the current repository
  - checkout: self

  # âœ… Set Node.js version to v20
  - task: UseNode@1
    inputs:
      version: "20"
    displayName: "Set Node.js to v20"

  # ğŸ” Debugging Step: List all files in the current directory
  - script: |
      ls -la
    displayName: "Check Files in Current Directory"

  # ğŸ” Debugging Step: Find all Playwright test files (*.spec.ts)
  - script: |
      find . -name "*.spec.ts"
    displayName: "Find Playwright Test Files"

  # âœ… Install Dependencies
  - script: |
      npm install
    displayName: "Install Dependencies"

  # âœ… Lint the Code with ESLint
  - script: |
      npm run lint
    displayName: "Run ESLint Check"

  # âœ… Format the Code with Prettier
  - script: |
      npm run format
    displayName: "Run Prettier Check"

  # âœ… Seed the Database and Start the Node.js Server
  - script: |
      npm run setup-and-start &
    displayName: "Seed Database and Start Server"

  # â³ Wait for Server to Start
  - script: |
      sleep 10
    displayName: "Wait for Server to Start"

  # âœ… Run Playwright Tests with JUnit Reporting
  - script: |
      npx playwright test src/tests/api --workers=1 --reporter=junit --output=reports
    displayName: "Run Playwright API Tests and Generate JUnit Reports"

  # âœ… Publish JUnit Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "reports/*.xml"
      testRunTitle: "Playwright API Tests"
    displayName: "Publish JUnit Test Results"
