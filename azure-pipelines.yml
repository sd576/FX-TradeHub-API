trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

steps:
  # Checkout the API Server repository
  - checkout: self
    displayName: "Checkout API Server (FX-TradeHub-API)"

  # Install Node.js 18
  - task: NodeTool@0
    inputs:
      versionSpec: "18"
    displayName: "Install Node.js 18"

  # Install dependencies for the API server
  - script: |
      cd fx_trader_server
      npm ci
    displayName: "Install API Server dependencies"

  # Start the API server in the background and wait for readiness
  - script: |
      cd fx_trader_server
      nohup npm start > nohup.out 2>&1 &
      for i in {1..15}; do
        curl -s http://localhost:3000/api/nostro-accounts && break || sleep 1
      done
      cat nohup.out
    displayName: "Start API Server and Wait for Readiness"

  # Clone the Playwright API Tests repository
  - script: |
      git clone https://github.com/sd576/Playwright-API-Tests.git /tmp/fx_trader_api
      cd /tmp/fx_trader_api
      npm ci
    displayName: "Clone and set up Playwright tests"

  # List Available CRUD Tests
  - script: |
      cd /tmp/fx_trader_api
      npx playwright test --project="CRUD tests" --list
    displayName: "List CRUD Tests"

  # List Available Negative Tests
  - script: |
      cd /tmp/fx_trader_api
      npx playwright test --project="Negative tests" --list
    displayName: "List Negative Tests"

  # Run Playwright Tests for CRUD Tests
  - script: |
      cd /tmp/fx_trader_api
      npx playwright test --project="CRUD tests" --reporter=junit --output=test-results/crud
    displayName: "Run CRUD Tests"

  # Run Playwright Tests for Negative Tests
  - script: |
      cd /tmp/fx_trader_api
      npx playwright test --project="Negative tests" --reporter=junit --output=test-results/negative
    displayName: "Run Negative Tests"

  # Publish Playwright Test Results
  - task: PublishTestResults@2
    inputs:
      searchFolder: "/tmp/fx_trader_api/test-results"
      testResultsFormat: "JUnit"
      testResultsFiles: "**/*.xml"
      mergeTestResults: true
      failTaskOnFailedTests: true
    displayName: "Publish Playwright Test Results"

  # Publish the Playwright report as an artifact
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: /tmp/fx_trader_api/playwright-report
      artifact: playwright-report
      publishLocation: "pipeline"
    displayName: "Publish Playwright Report"
    condition: succeededOrFailed()
