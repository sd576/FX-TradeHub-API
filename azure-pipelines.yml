trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

steps:
  # ✅ Checkout the Repository
  - checkout: self

  # ✅ Install Node.js
  - task: UseNode@1
    inputs:
      version: "20"
    displayName: "Set Node.js to v20"

  # ✅ Step 1: Install All Node Dependencies
  - script: |
      npm ci
      echo "✅ Node.js dependencies installed."
    displayName: "Install Node Dependencies"

  # ✅ Install Dependencies and Playwright
  - script: |
      npx playwright install --with-deps
      echo "✅ Playwright and browsers installed."
    displayName: "Install Playwright and System Dependencies"

  # ✅ Run Playwright Tests with JUnit Reporter
  - script: |
      export CI=true
      npx playwright test src/tests/api --reporter=junit --workers=1 --output=playwright-results
    displayName: "Run Playwright Tests"

  # ✅ Publish Playwright Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "playwright-results/*.xml"
      testRunTitle: "Playwright Tests"
    displayName: "Publish Test Results"

  # ✅ Publish Playwright HTML Report as an Artifact
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: playwright-report
      artifact: PlaywrightHTMLReport
      publishLocation: pipeline
    displayName: "Publish Playwright HTML Report"
