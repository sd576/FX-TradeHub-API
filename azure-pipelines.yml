trigger:
  branches:
    include:
      - main # Runs pipeline when code is pushed to 'main' branch

pool:
  vmImage: "ubuntu-latest"

resources:
  repositories:
    - repository: Playwright_Tests_Repo
      type: github
      name: sd576/Playwright-API-Tests
      ref: refs/heads/main

steps:
  - checkout: self

  - task: UseNode@1
    inputs:
      version: "20"
    displayName: "Set Node.js to v20"

  # 🔍 Debugging Step 1: List files in the current directory
  - script: |
      ls -la
    displayName: "Check Files in Current Directory"

  # 🔍 Debugging Step 2: Locate package.json recursively
  - script: |
      find . -name "package.json"
    displayName: "Locate package.json"

  # ✅ Install Dependencies
  - script: |
      npm install
    displayName: "Install Dependencies"

  # ✅ Lint the Code with ESLint
  - script: |
      npm run lint
    displayName: "Run ESLint Check"

  # ✅ Format the Code with Prettier
  - script: |
      npm run format
    displayName: "Run Prettier Check"

  # ✅ Seed the Database and Start the Node.js Server
  - script: |
      npm run setup-and-start &
    displayName: "Seed Database and Start Server"

  # ⏳ Wait for Server to Start
  - script: |
      sleep 10
    displayName: "Wait for Server to Start"

  # ✅ Run API Tests
  - script: |
      npm run test:counterpartyAPI
      npm run test:settlementAPI
      npm run test:tradeAPI
    displayName: "Run API Tests"

  # ✅ Publish Mocha Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "reports/*.xml"
      testRunTitle: "Mocha API Tests"
    displayName: "Publish JUnit Test Results"
