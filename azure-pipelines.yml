trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

resources:
  repositories:
    - repository: Playwright_Tests_Repo
      type: github
      name: sd576/Playwright-API-Tests
      ref: refs/heads/main
      endpoint: GitHub_Connection  # This links the service connection

steps:
  - checkout: self  # Check out the API repo

  - task: UseNode@1
    inputs:
      version: '18'

  - script: |
      npm install
    displayName: "Install Dependencies"

  - script: |
      npm run start &
    displayName: "Start API Server in Background"

  - script: |
      for i in {1..10}; do
        curl -s http://localhost:3000 && break || sleep 2;
      done
    displayName: "Wait for API Server to be Ready"

  # âœ… Checkout Playwright Tests Repo from GitHub
  - checkout: Playwright_Tests_Repo
    path: tests
    displayName: "Checkout Playwright Tests from GitHub"

  - script: |
      npm install
    workingDirectory: tests
    displayName: "Install Playwright Dependencies"

  - script: |
      npx playwright test
    workingDirectory: tests
    displayName: "Run Playwright API Tests"

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: tests/playwright-report/
      artifactName: playwright-results
    displayName: "Upload Test Results"
