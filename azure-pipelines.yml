trigger:
  branches:
    include:
      - main # Run the pipeline on every push to 'main'

pool:
  vmImage: "ubuntu-latest"

resources:
  repositories:
    - repository: Playwright_Tests_Repo
      type: github
      name: sd576/Playwright-API-Tests
      ref: refs/heads/main
      endpoint: GitHub_Connection

steps:
  # ✅ Checkout the Repository
  - checkout: self

  # ✅ Set Node.js Version
  - task: UseNode@1
    inputs:
      version: "20"
    displayName: "Set Node.js to v20"

  # ✅ Install Dependencies
  - script: |
      npm install
    displayName: "Install Dependencies"

  # ✅ Lint and Format Code
  - script: |
      npm run lint
      npm run format
    displayName: "Run ESLint and Prettier Checks"

  # ✅ Start the Server in the Background
  - script: |
      nohup npm run setup-and-start > server.log 2>&1 &
    displayName: "Seed Database and Start Server"

  # ⏳ Wait for the Server to Start
  - script: |
      sleep 10
      cat server.log
    displayName: "Wait for Server to Start and Check Logs"

  # ✅ Run API Tests
  - script: |
      NODE_ENV=test npm run test:counterpartyAPI
      NODE_ENV=test npm run test:settlementAPI
      NODE_ENV=test npm run test:tradeAPI
    displayName: "Run API Tests"

  # ✅ Run Playwright Tests with JUnit Reporter
  - script: |
      npx playwright test --reporter=junit --output=playwright-results
    displayName: "Run Playwright Tests"

  # ✅ Publish Playwright JUnit Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "playwright-results/*.xml"
      testRunTitle: "Playwright API Tests"
    displayName: "Publish Playwright Test Results"
