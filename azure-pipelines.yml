trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

steps:
  # ‚úÖ Checkout the Repository
  - checkout: self

  # ‚úÖ Install System Dependencies (for Playwright)
  - script: |
      sudo apt-get update
      sudo apt-get install -y \
        libnss3 \
        libatk-bridge2.0-0 \
        libdrm2 \
        libxkbcommon0 \
        libxcomposite1 \
        libxrandr2 \
        libgbm1 \
        libpango-1.0-0 \
        libcups2 \
        libxdamage1 \
        libxshmfence1 \
        libgstreamer-gl1.0-0 \
        libgstreamer-plugins-bad1.0-0 \
        libgstreamer-plugins-base1.0-0 \
        gstreamer1.0-libav \
        gstreamer1.0-plugins-bad \
        gstreamer1.0-plugins-base \
        gstreamer1.0-plugins-good \
        gstreamer1.0-plugins-ugly \
        gstreamer1.0-pulseaudio
    displayName: "Install System Dependencies for Playwright"

  # ‚úÖ Set Node.js Version
  - task: UseNode@1
    inputs:
      version: "20"
    displayName: "Set Node.js to v20"

  # ‚úÖ Install Dependencies and Playwright
  - script: |
      npm ci
      echo "Dependencies installed successfully."
      npx playwright install
    displayName: "Install Dependencies and Playwright"

  # ‚úÖ Lint and Format Code
  - script: |
      npm run lint
      npm run format
    displayName: "Run ESLint and Prettier Checks"

  # ‚úÖ Seed the Database and Start the API Server in the Background
  - script: |
      npm run setup-and-start &
      echo "Server starting in the background..."
    displayName: "Seed Database and Start Server"

  # ‚è≥ Wait for the Server to be Ready
  - script: |
      for i in {1..10}; do
        if curl --silent http://localhost:3000/api-docs; then
          echo "Server is ready!"
          exit 0
        else
          echo "Waiting for server... Attempt $i"
          sleep 5
        fi
      done
      echo "Server failed to start in time."
      exit 1
    displayName: "Wait for Server to Start"

  # ‚úÖ Debugging Step: Print Full Directory Structure
  - script: |
      pwd
      ls -R
    displayName: "Print Full Directory Structure"

  # üèÉ Run Playwright Tests with a Different Port (4000)
  - script: |
      export CI=true
      PORT=4000 NODE_ENV=playwright npx playwright test src/tests/api --reporter=junit --output=playwright-results
    displayName: "Run Playwright Tests"

  # ‚úÖ Publish Playwright JUnit Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "playwright-results/*.xml"
      testRunTitle: "Playwright Tests"
    displayName: "Publish Playwright Test Results"
