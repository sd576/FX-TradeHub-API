trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

steps:
  # ✅ Checkout API Server Repository
  - checkout: self
    displayName: "Checkout API Server"

  # ✅ Clone Playwright Test Repository
  - script: |
      git clone https://github.com/sd576/Playwright-API-Tests API_Playwright/fx_trader_api
      cd API_Playwright/fx_trader_api
      echo "✅ Cloned Playwright Test Repo."
    displayName: "Clone Playwright Test Repo"

  # ✅ Install Dependencies for Playwright Tests
  - script: |
      cd API_Playwright/fx_trader_api
      npm ci
      npm install @playwright/test --save-dev
      npx playwright install --with-deps
      echo "✅ Installed Playwright and dependencies."
    displayName: "Install Playwright Dependencies"

  # ✅ Verify Playwright Installation
  - script: |
      cd API_Playwright/fx_trader_api
      if [ ! -d "node_modules/@playwright/test" ]; then
        echo "❌ Playwright not installed!"
        exit 1
      fi
      echo "✅ Playwright is installed."
    displayName: "Verify Playwright Installation"

  # ✅ Run Playwright Tests
  - script: |
      cd API_Playwright/fx_trader_api
      export CI=true
      npx playwright test src/tests/api --reporter=junit --workers=1 --output=test-results
      echo "✅ Playwright tests completed."
    displayName: "Run Playwright Tests"

  # ✅ Publish Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "API_Playwright/fx_trader_api/test-results/*.xml"
      mergeTestResults: true
      failTaskOnFailedTests: true
      testRunTitle: "Playwright API Tests"
    displayName: "Publish Test Results"
    condition: succeededOrFailed()

  # ✅ Publish Playwright HTML Report
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: "API_Playwright/fx_trader_api/playwright-report"
      artifact: playwright-report
      publishLocation: pipeline
    displayName: "Publish Playwright Report"
    condition: succeededOrFailed()
