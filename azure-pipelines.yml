trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

steps:
  # ✅ Step 1: Checkout the API Server Repository
  - checkout: self
    displayName: "Checkout API Server"

  # ✅ Step 2: Clone Playwright Test Repository
  - script: |
      git clone https://github.com/sd576/Playwright-API-Tests API_Playwright/fx_trader_api
      echo "✅ Cloned Playwright Test Repo."
    displayName: "Clone Playwright Test Repo"

  # ✅ Step 3: Install Dependencies for Playwright Tests
  - script: |
      cd API_Playwright/fx_trader_api
      npm ci
      echo "✅ Installed Playwright and dependencies."
    displayName: "Install Playwright Dependencies"

  # ✅ Step 4: Debugging - Check Directory and Test Files
  - script: |
      pwd
      ls -la
      cd API_Playwright/fx_trader_api
      ls -la src/tests/api
      echo "✅ Directory and test files verified."
    displayName: "Check Current Directory and List Test Files"

  # ✅ Step 5: Run Playwright Tests
  - script: |
      cd API_Playwright/fx_trader_api
      npx playwright test src/tests/api --reporter=junit --output=test-results
      echo "✅ Playwright tests completed."
    displayName: "Run Playwright Tests"

  # ✅ Step 6: Publish Test Results
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "API_Playwright/fx_trader_api/test-results/*.xml"
      mergeTestResults: true
      failTaskOnFailedTests: true
      testRunTitle: "Playwright API Tests"
    displayName: "Publish Test Results"
    condition: succeededOrFailed()

  # ✅ Step 7: Publish Playwright HTML Report
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: "API_Playwright/fx_trader_api/playwright-report"
      artifact: playwright-report
      publishLocation: pipeline
    displayName: "Publish Playwright Report"
    condition: succeededOrFailed()
